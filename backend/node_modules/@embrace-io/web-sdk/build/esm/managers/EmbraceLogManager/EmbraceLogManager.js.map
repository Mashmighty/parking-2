{"version":3,"file":"EmbraceLogManager.js","sources":["../../../../src/managers/EmbraceLogManager/EmbraceLogManager.ts"],"sourcesContent":["import { diag } from '@opentelemetry/api';\nimport type { AttributeValue, DiagLogger } from '@opentelemetry/api';\nimport type { Logger } from '@opentelemetry/api-logs';\nimport { logs, SeverityNumber } from '@opentelemetry/api-logs';\nimport {\n  ATTR_EXCEPTION_MESSAGE,\n  ATTR_EXCEPTION_STACKTRACE,\n  ATTR_EXCEPTION_TYPE,\n} from '@opentelemetry/semantic-conventions';\nimport type { LogManager, LogSeverity } from '../../api-logs/index.js';\nimport {\n  EMB_TYPES,\n  KEY_EMB_EXCEPTION_HANDLING,\n  KEY_EMB_JS_EXCEPTION_STACKTRACE,\n  KEY_EMB_TYPE,\n} from '../../constants/index.js';\nimport { OTelPerformanceManager } from '../../utils/index.js';\nimport type { PerformanceManager } from '../../utils/index.js';\nimport type { EmbraceLogManagerArgs } from './types.js';\nimport type {\n  LogExceptionOptions,\n  LogMessageOptions,\n} from '../../api-logs/manager/index.js';\nimport type { SpanSessionManagerInternal } from '../EmbraceSpanSessionManager/index.js';\nimport {\n  KEY_EMB_ERROR_LOG_COUNT,\n  KEY_EMB_UNHANDLED_EXCEPTIONS_COUNT,\n} from '../../constants/attributes.js';\nimport type { LimitManagerInternal } from '../EmbraceLimitManager/index.js';\n\nexport class EmbraceLogManager implements LogManager {\n  private readonly _diag: DiagLogger;\n  private readonly _perf: PerformanceManager;\n  private readonly _logger: Logger;\n  private readonly _spanSessionManager: SpanSessionManagerInternal;\n  private readonly _limitManager: LimitManagerInternal;\n\n  public constructor({\n    diag: diagParam,\n    perf,\n    spanSessionManager,\n    limitManager,\n  }: EmbraceLogManagerArgs) {\n    this._diag =\n      diagParam ??\n      diag.createComponentLogger({\n        namespace: 'EmbraceLogManager',\n      });\n    this._perf = perf ?? new OTelPerformanceManager();\n    this._logger = logs.getLogger('embrace-web-sdk-logs');\n    this._spanSessionManager = spanSessionManager;\n    this._limitManager = limitManager;\n  }\n\n  private static _logSeverityToSeverityNumber(\n    severity: LogSeverity\n  ): SeverityNumber {\n    switch (severity) {\n      case 'info':\n        return SeverityNumber.INFO;\n      case 'warning':\n        return SeverityNumber.WARN;\n      default:\n        return SeverityNumber.ERROR;\n    }\n  }\n\n  public logException(\n    error: unknown,\n    {\n      handled = true,\n      attributes = {},\n      timestamp = this._perf.getNowMillis(),\n    }: LogExceptionOptions = {}\n  ) {\n    if (!error) {\n      error = new Error('logException received an undefined error');\n    }\n\n    // real user input may be null but TS doesn't know that\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (attributes == null || typeof attributes !== 'object') {\n      this._diag.warn('attributes must be a non-null object', attributes);\n      attributes = {};\n    }\n\n    if (!handled) {\n      this._spanSessionManager.incrSessionCountForKey(\n        KEY_EMB_UNHANDLED_EXCEPTIONS_COUNT\n      );\n    }\n\n    const normalizedError = EmbraceLogManager._normalizeErrorData(error);\n\n    this._logger.emit({\n      timestamp,\n      severityNumber: SeverityNumber.ERROR,\n      severityText: 'ERROR',\n      body: normalizedError.message,\n      attributes: {\n        ...attributes,\n        [KEY_EMB_TYPE]: EMB_TYPES.SystemException,\n        [KEY_EMB_EXCEPTION_HANDLING]: handled ? 'HANDLED' : 'UNHANDLED',\n        [ATTR_EXCEPTION_TYPE]: normalizedError.type,\n        ['exception.name']: normalizedError.name,\n        [ATTR_EXCEPTION_MESSAGE]: normalizedError.message,\n        [ATTR_EXCEPTION_STACKTRACE]: normalizedError.stack,\n      },\n    });\n  }\n\n  public message(\n    message: string,\n    severity: LogSeverity,\n    {\n      attributes = {},\n      includeStacktrace = true,\n      stacktrace,\n    }: LogMessageOptions = {}\n  ) {\n    if (!message || typeof message !== 'string') {\n      this._diag.warn('Message must be a string');\n      return;\n    }\n\n    if (severity === 'error') {\n      this._spanSessionManager.incrSessionCountForKey(KEY_EMB_ERROR_LOG_COUNT);\n    }\n\n    let stacktraceString = '';\n    if (severity !== 'info') {\n      if (stacktrace) {\n        stacktraceString = stacktrace;\n      } else if (includeStacktrace) {\n        stacktraceString = new Error().stack || '';\n      }\n    }\n\n    this._logMessage({\n      message: message.trim(),\n      severity,\n      timestamp: this._perf.getNowMillis(),\n      attributes,\n      stacktrace: stacktraceString,\n    });\n  }\n\n  private _logMessage({\n    message,\n    severity,\n    timestamp,\n    attributes = {},\n    stacktrace,\n  }: {\n    message: string;\n    severity: LogSeverity;\n    timestamp: number;\n    attributes?: Record<string, AttributeValue | undefined>;\n    stacktrace?: string;\n  }) {\n    const limitedLog = this._limitManager.limitLog(\n      message,\n      severity,\n      attributes\n    );\n\n    if (limitedLog === 'dropped') {\n      return;\n    }\n\n    this._logger.emit({\n      timestamp,\n      severityNumber: EmbraceLogManager._logSeverityToSeverityNumber(severity),\n      severityText: severity.toUpperCase(),\n      body: limitedLog.message,\n      attributes: {\n        ...limitedLog.attributes,\n        [KEY_EMB_TYPE]: EMB_TYPES.SystemLog,\n        ...(stacktrace\n          ? {\n              [KEY_EMB_JS_EXCEPTION_STACKTRACE]: stacktrace,\n            }\n          : {}),\n      },\n    });\n  }\n\n  private static _normalizeErrorData(error: unknown): {\n    message: string;\n    type: string;\n    name: string;\n    stack: string; // 'stack' not 'stacktrace' here to match the standard Error.stack property name\n  } {\n    if (error instanceof Error) {\n      return {\n        message: typeof error.message === 'string' ? error.message.trim() : '',\n        type: error.constructor.name,\n        name: error.name,\n        stack: error.stack || '',\n      };\n    }\n\n    // For non-Error types, generate a new stack trace\n    const userCallStack = new Error().stack || '';\n\n    if (typeof error === 'string') {\n      return {\n        message: String(error).trim(),\n        type: 'String',\n        name: 'String',\n        stack: userCallStack,\n      };\n    }\n\n    if (error && typeof error === 'object') {\n      let message = '';\n      try {\n        message = JSON.stringify(error);\n      } catch {\n        message = '[unable to serialize error]';\n      }\n\n      return {\n        message,\n        type: error.constructor.name,\n        name: error.constructor.name,\n        stack: userCallStack,\n      };\n    }\n\n    return {\n      message: String(error).trim(),\n      type: typeof error,\n      name: typeof error,\n      stack: userCallStack,\n    };\n  }\n}\n"],"names":["EmbraceLogManager","diag","diagParam","perf","spanSessionManager","limitManager","_diag","createComponentLogger","namespace","_perf","OTelPerformanceManager","_logger","logs","getLogger","_spanSessionManager","_limitManager","_logSeverityToSeverityNumber","severity","SeverityNumber","INFO","WARN","ERROR","logException","error","handled","attributes","timestamp","getNowMillis","Error","warn","incrSessionCountForKey","KEY_EMB_UNHANDLED_EXCEPTIONS_COUNT","normalizedError","_normalizeErrorData","emit","severityNumber","severityText","body","message","KEY_EMB_TYPE","EMB_TYPES","SystemException","KEY_EMB_EXCEPTION_HANDLING","ATTR_EXCEPTION_TYPE","type","name","ATTR_EXCEPTION_MESSAGE","ATTR_EXCEPTION_STACKTRACE","stack","includeStacktrace","stacktrace","KEY_EMB_ERROR_LOG_COUNT","stacktraceString","_logMessage","trim","limitedLog","limitLog","toUpperCase","SystemLog","KEY_EMB_JS_EXCEPTION_STACKTRACE","userCallStack","String","JSON","stringify"],"mappings":"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"}